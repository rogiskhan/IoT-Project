# -*- coding: utf-8 -*-
"""
Created on Sat Apr  4 15:40:27 2020

@author: monal
"""

import paho.mqtt.publish as publish
import time
class Comunic_ThingSpeak:

    def __init__(self):
    ###   Start of user configuration   ###
        #  ThingSpeak Channel Settings

        # The ThingSpeak Channel ID
        self.channelID = "1030386"

        # The Write API Key for the channel
        self.apiKey = "G54YTEUG4KX0I8EW"

        #  MQTT Connection Methods

        # Set useUnsecuredTCP to True to use the default MQTT port of 1883
        # This type of unsecured MQTT connection uses the least amount of system resources.
        useUnsecuredTCP = False

        # Set useUnsecuredWebSockets to True to use MQTT over an unsecured websocket on port 80.
        # Try this if port 1883 is blocked on your network.
        useUnsecuredWebsockets = False

        # Set useSSLWebsockets to True to use MQTT over a secure websocket on port 443.
        # This type of connection will use slightly more system resources, but the connection
        # will be secured by SSL.
        useSSLWebsockets = True

        ###   End of user configuration   ###

        # The Hostname of the ThinSpeak MQTT service
        self.mqttHost = "mqtt.thingspeak.com"

        # Set up the connection parameters based on the connection type
        if useUnsecuredTCP:
            self.tTransport = "tcp"
            self.tPort = 1883
            self.tTLS = None

        if useUnsecuredWebsockets:
            self.tTransport = "websockets"
            self.tPort = 80
            self.tTLS = None

        if useSSLWebsockets:
            import ssl

            self.tTransport = "websockets"
            self.tTLS = {'ca_certs': "/etc/ssl/certs/ca-certificates.crt", 'tls_version': ssl.PROTOCOL_TLSv1}
            self.tPort = 443
     
    def send_ts(self,ritardo):
        # Create the topic string
        self.topic = "channels/" + channelID + "/publish/" + apiKey

        # invio a entrambi i canali il ritardo, uno dei due grafici mi far√†
        # direttamente la media

        tPayload = "field1=" + str(self.ritardo) + "&field2=" + str(self.ritardo)
        # attempt to publish this data to the topic
        try:
            publish.single(topic, payload=tPayload, hostname=mqttHost, port=tPort, tls=tTLS, transport=tTransport)
            time.sleep(20)

        except (KeyboardInterrupt):
           
            print("error")

        except:
            print("There was an error while publishing the data.")
            time.sleep(0.5)

if __name__=="__main__":
    c=Comunic_ThingSpeak()
    c.send_ts("'17:00':20")
    
